## Заметка
Все сложные слова со сноской находятся в словаре. Ссылка на [[Словарь]]

В SQL физическое соединение (join) - это операция, которая объединяет строки из двух или более таблиц на основе некоторого условия. Физические соединения относятся к способам, которыми SQL серверы выполняют эти операции на низком уровне. Различные типы физического соединения имеют разные алгоритмы реализации, которые могут быть выбраны автоматически сервером в зависимости от структуры данных и условий соединения.

## Основные типы физического соединения:
## Nested Loops Join (соединение вложенными циклами)
Это простой, но не всегда эффективный способ выполнения соединений, особенно если объем данных велик. Этот алгоритм работает так:
1. Для каждой строки из первой таблицы (внешняя таблица) выполняется цикл.
2. Для каждой строки из второй таблицы (внутренняя таблица) выполняется вложенный цикл.
3. Если условие соединения выполнено, то пара строк включается в результирующий набор.
```SQL
SELECT e.name, d.department_name
FROM employees e
JOIN department d ON e.department_id = d.department_id
```
Если алгоритм соединения выбран как Nested Loops Join то для каждой строки из таблицы employees, будет выполняться поиск соответствующей строки в таблицу departments
### Merge JOIN (сортировочное соединение)
Merge Join требует предварительной сортировки обеих таблиц по ключевым столбцам соединения. Алгоритм работает следующим образом:
1. Обе таблицы сортируются по столбцам соединения
2. Затем данные из обеих таблиц сканируются по порядку и строки с совпадающими значениями соединяются.
Этот алгоритм хорошо работает, когда обе таблицы уже отсортированы или когда они возвращают большие объемы данных, так как он не может быть более производительным чем Nested Loops Join.

```SQL
SELECT e.name, d.department_name
FROM employees e
JOIN departments d ON e.departments_id = d.departments_id;
```
Если оптимизатор SQL решит использовать Merge JOIN, обе таблицы будут отсортированы по departments_id и соединения произойдет путем последовательного сравнения строк.

### Hash JOIN (Хешированное соединение)
Этот алгоритм используется когда одна из таблиц достаточно мала, чтобы поместиться в памяти. Процесс выполнения состоит из двух этапов:
1. Build phase (фаза построения): на основе меньшей таблицы создается хеш-таблица в памяти по ключу соединения.
2. Probe phase (фаза поиска): строки из другой таблицы сравниваются с хеш-таблицей и если находится соответствие, то строки соединяются.
Hash Join часто используется для соединения больших таблиц, особенно когда на столбцах соединения нет индексов.
```SQL
SELECT e.name, d.department_name
FROM employees e
JOIN department d ON e.department_id = d.department_id
```
Если оптимизатор выберет Hash Join, то, скажем, для таблицы departments может быть создана хеш-таблица, которая затем будет использоваться для поиска соответствующих строк из таблицы employees.
### Sort-Merge JOIN (соединение сортировка-слияние)
Это специфический случай Merge Join, где предварительная сортировка выполняется для обеспечения того чтобы обе таблицы были отсортированы. Используется, когда таблицы не отсортированы и сортировка необходима для выполнения соединения. Этот тип соединения сочетает в себе сортировку и последующее соединение.
```SQL
SELECT e.name, d.department_name
FROM employees e
JOIN departments d ON e.departments_id = ddepartments_id
ORDER BY e.departments_id;
```
Здесь SQL сервер может выбрать SORT-MERGE JOIN, если данные не отсортированы и потребуется дополнительная сортировка перед выполнением соединения.

## Заключение
Физические типы соединений в SQL определяют, как именно сервер базы данных будет выполнять операции соединения. Выбор конкретного алгоритма соединения зависит от различных факторов, таких как объем данных, наличие индексов, структура таблиц и условия соединения. Понимание этих механизмов может быть полезным для оптимизации производительности запросов в базах данных.

## Виды JOIN
### INNER JOIN (Внутреннее соединение)
INNER JOIN возвращает только те строки, которые имеют совпадения в обеих таблицах на основе заданного условия соединения. 
#### Пример
Предположим у нас есть две таблицы employees (сотрудники) и departments (отделы)

Таблица EMPLOYEES имеет следующий вид

| employee_id | name    | department_id |
| ----------- | ------- | ------------- |
| 1           | Alice   | 10            |
| 2           | Bob     | 20            |
| 3           | Charlie | 30            |
Таблица DEPARTMENT выглядит следующим образом

|department_id|department_name|
|---|---|
|10|Sales|
|20|Marketing|
|40|IT|
Запрос с INNER JOIN
```SQL
SELECT e.name, d.department_name
FROM employees e
INNER JOIN departmants d ON e.departments_id = d.department_id;
```
Результат:

| name  | department_name |
| ----- | --------------- |
| Alice | Sales           |
| Bob   | Marketing       |
Здесь только строки, где есть соответствие между department_id в обеих таблицах, включены в результирующий набор.

### LEFT JOIN (или LEFT OUTER JOIN, левое внешнее соединение)
LEFT JOIN возвращает все строки из левой таблицы (той, что указана первой), и строки из правой таблицы, которые соответствуют условию соединения. Если соответствующих строк нет, то в результирующем наборе для правой таблицы будут возвращены NULL.
```SQL
SELECT e.name, d.department_name
FROM employees e
LEFT JOIN departments d ON e.department_id = d.department_id;
```
Результат:

|name|department_name|
|---|---|
|Alice|Sales|
|Bob|Marketing|
|Charlie|NULL|
Здесь включены все сотрудники, даже если для них нет соответствующего отдела.
### RIGHT JOIN (или RIGHT OUTER JOIN, правое внешнее соединение)
RIGHT JOIN аналогичен LEFT JOIN, но возвращает все строки из правой таблицы и соответствующие строки из левой таблицы. Если соответствующих строк нет, то в результирующем наборе для левой таблицы будут возвращены NULL.
```SQL
SELECT e.name, d.depatrment_name
FROM employees e
RIGHT JOIN departments d ON e.department_id = d.department_id;
```
Результат

| name  | department_name |
| ----- | --------------- |
| Alice | Sales           |
| Bob   | Marketing       |
| NULL  | IT              |
В этом случае все отделы, даже если для них нет сотрудников

### FULL JOIN (или FULL OUTER JOIN, полное внешнее совпадение)
FULL JOIN возвращает все строки, когда есть совпадение в одной из таблиц. Если нет совпадения, для отсутствующих столбцов возвращается NULL. ЭТо комбинация LEFT JOIN и RIGHT JOIN
```SQL
SELECT e.name, d.department_name
FROM employees e
FULL OUTER JOIN departments d ON e.department_id = d.department_id;
```
Результат:

|name|department_name|
|---|---|
|Alice|Sales|
|Bob|Marketing|
|Charlie|NULL|
|NULL|IT|
Здесь включены все строки из обеих таблиц.

### CROSS JOIN (Декартово произведение)
CROSS JOIN возвращает декартово произведение двух таблиц, то есть каждая строка из первой таблицы соединяется с каждой строкой из второй таблицы. Это приводит  очень большому числу строк, если обе таблицы содержат много записей.
```SQL
SELECT e.name, d.department_name
FROM employees e
CROSS JOIN departments d;
```
Результат:

|name|department_name|
|---|---|
|Alice|Sales|
|Alice|Marketing|
|Alice|IT|
|Bob|Sales|
|Bob|Marketing|
|Bob|IT|
|Charlie|Sales|
|Charlie|Marketing|
|Charlie|IT|
Здесь каждая строка из таблицы employees соединяется с каждой строкой из таблицы departments

## Условия соединения 
### ON/USING
#### ON: 
Указывает условие соединения для двух таблиц. Оно может быть любым логическим выражением.
```SQL
SELECT e.name, d.department_name
FROM employees e
JOIN departments d ON e.department_id = d.department_id;
```
#### USING:
Используется когда соединение происходит по столбцам с одинаковыми именами в обеих таблицах.
```SQL
SELECT e.name, d.department_name
FROM employees e
JOIN departments d USING (deparrtments_id)
```
## Заключение JOIN
JOIN - это мощный инструмент для объединения данных из разных таблиц в реляционной базе данных. Понимание различных типов соединений и их использование позволяет эффективно управлять и извлекать связанные данные, удовлетворяя сложные запросы. Выбор конкретного типа соединения зависит от требуемого результата и структуры данных в таблицах